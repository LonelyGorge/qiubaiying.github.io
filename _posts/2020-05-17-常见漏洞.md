---
layout:     post
title:      常见漏洞
date:       2020-05-17
author:     lceCr4m
header-img: img/loudong.jpg
catalog: true
tags:
    - 常见漏洞
---
> 本文关于之前学过的一些漏洞的理解。

# 0x00 前言
简单地对之前地漏洞进行复习，因为今晚有考试QAQ。  
好了，考了73，大哭。  
包含：SSRF，CSRF，文件，命令/代码，SQL注入。
# 0x01 SSRF
服务端请求伪造，发现这个漏洞后可以结合相关协议进行内网攻击。如果有302的话，美滋滋。  

危险函数（php）：
```
file_get_contents()， fsockopen()， curl_exec()
```
利用函数：
```
file读取文件， dict端口探测， gopher反弹shell ...
```
配合redis未授权访问写shell：

```
在内网机器上执行如下5行代码可以写入shell.php
redis-cli -h 127.0.0.1 flushall
redis-cli -h 127.0.0.1 config set dir /var/www
redis-cli -h 127.0.0.1 config set dbfilename shell.php
redis-cli -h 127.0.0.1 set webshell "<?php phpinfo();?>"
redis-cli -h 127.0.0.1 save

PS：需要抓取原始数据并进行两次url编码（因为传到内网解码了两次）。
```
绕过：短网址，xip.io，IP格式绕过，302跳转（只支持https时无法读取内容时可以使用302跳转，使的第二次转发使用http获取数据），dns/http log，time， 差异化导致的问题（不同语言和库对url的判断不同）...

防御：过滤返回的信息，统一错误信息，限制请求的端口，禁止不常用的协议，对DNS Rebinding，考虑使用DNS缓存或者Host白名单，使用https而不是http ...

# 0x02 CSRF
跨站请求伪造，给被害者发一段有漏洞的网站的你构造的恶意链接，如果被害者已经登录了那个网站，那么你可以利用被害者点击你发给他的恶意链接做一些事情，比如删掉自己的某条评论。

区别ssrf & xss：两者都是点击url链接触发，但是ssrf是利用有漏洞站点本身的漏洞，然后利用被害者已经登录的身份信息进行相关操作；而xss则是站点没有可以直接利用的身份信息，xss是利用被害者点击恶意链接，来向站点插入恶意js语句，这条语句可以盗取被害者信息。  
一句话概括：ssrf不盗取只利用，xss盗取后才能利用。

防御：referer，token，添加自定义字段，执行相关操作需要输入验证码 ... 

# 0x03 文件
## 目录遍历（穿越）
当访问者传递文件名后，Web应用程序即会自动添加完整路径，形如“d://site/images/image.jpg”，将读取的内容返回给访问者。由于文件名可以任意更改而服务器支持“~/”，“../”等特殊符号的目录回溯，从而使攻击者越权访问或者覆盖敏感数据。

使用 ../../ 进行目录穿越。
## 文件上传
这个没啥好说的，主要就是绕过的相关技术：  
js/MIME/文件头（文件幻数）/黑名单：大小写，重写，特殊可解析后缀，.htaccess绕过，利用windows特性：点，空格，%00截断/服务器解析漏洞：apache，iis6.0，nginx ...

绕过的技术太多了，但是一般都做了比较好的防护，各种过滤，各种名单等等，一点代码就解决了。
## 文件下载
利用：获取网站源码/获取网站配置/获取系统/应用配置（需要权限）等等一些敏感文件（不同操作系统默认的目录也是不同的）。  

漏洞发现：GoogleHacking，从链接发现，从参数发现。

防御：正则过滤，白名单，访问范围限制 ...
## 文件包含
哎说实话，这种就是理论研究研究，ctf可能出出，实际情况下谁没事包含个文件，不是自找苦吃。但还是说说吧。

分为本地文件包含和远程文件包含（反正我搭建的话是不会包含远程文件的）。远程文件包含需要开启相关设置。

利用：file://读文件   http://   包含上传的文件  包含日志文件   包含session   php伪协议：php://input配合文件包含可以执行任意代码   php://filter读取文件   zip://和文件包含配合可以执行任意代码   phar://类似zip   data://配合文件包含执行任意代码   其他扩展 ...

绕过：前缀限制绕过（使用目录穿越），后缀绕过（使用url（加？或者#），使用协议（zip，phar））。

防御：allow关闭/限制目录open_basedir/白名单限制能包含的文件名。
# 0x04 命令/代码
一般可以通过审计来发现此类漏洞。由于调用相关的执行函数时没有对用户输入的参数进行过滤，导致执行了恶意的代码或命令。在白盒审计中，通过找 相关函数/可控参数 来寻找此类漏洞。

命令执行：
```
system,exec,passthru,``,shell_exec,pcntl_exec,popen,ob_start 等等函数
```
代码执行（php）：
```
eval，assert，preg_replace、+/e模式（PHP版本<5.5.0），call_user_func，call_user_func_array，array_map 等等函数
```
绕过：
命令操作符：| , & , ; , && , || 。   空格绕过：${IFS}，{}，tab键，重定向符。  
黑名单关键字绕过：字符串拼接，利用环境变量，使用空变量，利用linux通配符，使用反斜杠，base64编码。  
无回显情况：使用其他通道带出结果，利用平台：CEYE。  
防御：过滤参数，白名单。
# 0x05 SQL注入
利用，探测，绕过，防御  
四种注入放式，探测方式：数字/字符/搜索，如何绕过，预编译+绑定变量/过滤。









