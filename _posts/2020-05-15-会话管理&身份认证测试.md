---
layout:     post
title:      会话管理&身份认证测试
date:       2020-05-15
author:     lceCr4m
header-img: img/huihuaguanlishenfenrenzheng.png
catalog: true
tags:
    - 会话管理&身份认证测试
---
> 本文主要关于会话管理测试和身份认证测试。  
加强web安全性的第一条原则——不要信任来自客户端的数据，但由于Http的无状态性，为了维持来自同一个用户的不同请求之间的状态，必须存在会话管理机制与身份认证机制，而这两个机制也导致了web的脆弱性。

# 0x00 前言
本来是打算分开写的，但是每个内容都不算很多，所以合起来了。最终也可能和业务逻辑测试进行适当的结合。
# 0x01 会话管理测试
## 思维导图
![huihuaguanli](https://github.com/lceCre4m/lceCre4m.github.io/blob/master/img/huihuaguanli.png?raw=true)
## cookie属性测试
![cookie](https://github.com/lceCre4m/lceCre4m.github.io/blob/master/img/cookie.png?raw=true)  
**其他重要属性**：  
HttpOnly：该属性可防止客户端脚本访问cookie，但不能消除跨站脚本带来的风险，测试是否设置该属性。  
Expires：该属性设置成一个将来的时间，验证cookie没有包含任何敏感的信息。
## Session攻击手段
### 会话劫持
介绍：  
会话劫持（Session hijacking），一种通过获取用户Session ID后，使用该Session ID登录目标账号的攻击方法，此时攻击者实际上是使用了目标账户的有效Session。  

攻击：  
- 暴力破解：尝试各种Session ID，直到破解为止。
- 预测：如果Session ID使用非随机的方式产生，那么就有可能计算出来。
- 窃取：使用网络嗅探，XSS攻击等方法获得。

防御：  
- 更改Session名称。PHP中Session的默认名称是PHPSESSID，此变量会保存在Cookie中。
- 关闭透明化Session ID。透明化Session ID指当浏览器中的Http请求没有使用Cookie来存放Session ID时，Session ID则使用URL来传递。
- 设置HttpOnly。可以防止客户端脚本访问这个Cookie，从而有效的防止XSS攻击。
- 使用User-Agent检测请求的一致性。（问题：服务器群集中的HTTP代理服务器会对User-Agent进行编辑，而本群集中的多个代理服务器在编辑该值时可能会不一致。）
- 加入Token校验。
### 会话固定
介绍：  
会话固定（Session fixation）是一种诱骗受害者使用攻击者指定的会话标识（SessionID）的攻击手段。让合法用户使用黑客预先设置的sessionID进行登录，从而是Web不再进行生成新的sessionID，从而导致黑客设置的sessionId变成了合法桥梁。

重置ID：  
- 使用客户端脚本来设置Cookie到浏览器。
- 使用HTML的<META>标签加Set-Cookie属性。
- 使用Set-Cookie的HTTP响应头部设置Cookie。

防御：
- 每当用户登陆的时候就进行重置sessionID。
- sessionID闲置过久时，进行重置sessionID。
- 防止会话劫持的方法对会话固定攻击同样有效。如设置HttpOnly，关闭透明化SessionID，Token校验等。
# 0x02 身份认证测试
## 弱口令
用户账号使用弱口令，可以实现爆破。  
设置密码时要求复杂度达到级别，否则不允许。
## 空口令
认证登录环节允许空口。
## 登录错误消息凭证枚举
当用户输入无效的用户名和无效的密码时，应用程序会分别生成不同的错误消息。通过利用该行为攻击者可以通过反复试验，加暴力破解来发现应用程序的有效用户名、再继续尝试发现相关联的密码。   
不论用户名或密码出现问题都提示同样的错误，且同时加上登陆失败次数达到规定次数，则执行帐户锁定功能。 
## HTML注释敏感身份信息泄露 
将html中有关密码之类的敏感注释去掉或者用<%-- -%>隐式注释。 
## 越权
通常情况下，一个 Web 程序功能流程是登录–提交请求–验证权限–数据库查询–返回结果。如果验证权限不足，便会导致越权。常见的程序都会认为通过登录后即可验证用户的身份，从而不会做下一步验证，最后导致越权。  

方式：  
1. 通过隐藏 URL  
实现控制访问有些程序的管理员的管理页面只有管理员才显示，普通用户看不到，利用 URL 实现访问控制，但 URL 泄露或被恶意攻击者猜到后，这会导致越权攻击。
2. 直接对象引用  
通过修改一下参数就可以产生水平越权，例如查看用户信息页面 URL 后加上自己的 id 便可查看，当修改为他人的 id 号时会返回他人的信息，便产生了水平越权。
3. 多阶段功能  
多阶段功能是一个功能有多个阶段的实现。例如修改密码，可能第一步是验证用户身份信息，号码验证码类的。当验证成功后，跳到第二步，输入新密码，很多程序会在这一步不再验证用户身份，导致恶意攻击者抓包直接修改参数值，导致可修改任意用户密码。
4. 静态文件  
很多网站的下载功能，一些被下载的静态文件，例如 pdf、word、xls 等，可能只有付费用户或会员可下载，但当这些文件的 URL 地址泄露后，导致任何人可下载，如果知道 URL 命名规则，则会便利服务器的收费文档进行批量下载。
5. 平台配置错误  
一些程序会通过控件来限制用户的访问，例如后台地址，普通用户不属于管理员组，则不能访问。但当配置平台或配置控件错误时，就会出现越权访问。

防御：  
- 前后端同时对用户输入信息进行校验，双重验证机制。
- 执行关键操作前必须验证用户身份，验证用户是否具备操作数据的权限。
- 特别敏感操作可以让用户再次输入密码或其他的验证信息。
- 可以从用户的加密认证 cookie 中获取当前用户 id，防止攻击者对其修改。或在 session、cookie 中加入不可预测、不可猜解的 user 信息。
- 直接对象引用的加密资源ID，防止攻击者枚举ID，敏感数据特殊化处理。
- 永远不要相信来自用户的输入，对于可控参数进行严格的检查与过滤。

