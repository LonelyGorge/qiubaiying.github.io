---
layout:     post
title:      WAF
date:       2020-06-02
author:     lceCr4m
header-img: img/17.jpg
catalog: true
tags:
    - WAF
---
> 本文是关于waf的相关内容。  

# 0x00 前言
本文计划写两个大部分：waf的整体了解和waf的绕过。第一部分包含很多细枝末节，会分许多小块说明。以waf介绍为主。

# 0x01 WAF说明
## waf功能
WAF全称叫Web Application Firewall，和传统防火墙的区别是：它是工作在应用层的防火墙，主要对web请求/响应进行防护。

功能：
- 禁止HTTP协议的非安全方法
- 伪装Web服务的特征
- 防止API和命令注入
- 防止路径遍历和文件包含注入，对敏感的系统路径进行保护
- 防止sql注入
- 防止XSS攻击
- 防止网页挂马 
- 防护CC攻击
- 文件上传的防护
- 动态IP黑名单
- 白名单
- 与实时计算平台对接

2020年全球爆发新冠疫情重创经济，5G和物联网可能会快速崛起拉动经济，HTTPS加密已经普及，传统的防火墙检测功能失效，所以对于服务器来说，部署一个WEB应用防火墙十分重要。
## waf分类
云waf：阿里云盾，腾讯云waf，创宇盾，CloudFlare等  

软waf：安全狗，D盾，云锁，360卫士，ModSecurity等  

硬waf：启明星辰，吕蒙，天融信，Fortinet（飞塔）等

## waf部署
云waf模式：基于dns解析的云waf  

嵌入模式：嵌入web服务器模块  

串联模式：透明网桥，反向代理，路由代理，交换机代理 

旁路模式：镜像流量  
## waf工作
waf触发大概分为四个部分：++身份认证阶段，数据包解析阶段，规则触发阶段，日志记录阶段++。在下面关于waf绕过的介绍中，针对前三个阶段进行waf绕过的分类。

waf工作模式：关闭模式，监听模式，防护模式。

waf规则：一条WAF规则往往包含：id，解码器，过滤条件，阶段，动作，日志格式和严重级别。  
waf规则主要用于（拦截有害）请求和（伪装）相应阶段，关于请求又可以分为网络层（拦截）和应用层（拦截）。

不同waf产品对于waf动作定义不同，大多参考开源的ModSecurity。  
ModSecurity定义了allow，block，deny，drop，pass，pause，proxy，redirect。  
- allow: 命中了某条规则后，不需要对请求/响应应用其它规则，直接让请求通过。这个可以用于白名单。
- block: 并不是一个真正的动作，它的行为取决于配置的默认动作，如果默认动作更新，使用block的规则行为也随即改变。在安全响应方面，它可用于批量进行规则作为更新。
- deny: 中断规则处理，拦截请求/响应。在客户端的角度来说，这个动作会返回4xx或5xx的状态码（取决于规则定义status)，但并没有中断当前的连接
- drop:  对当前tcp连接进行关闭操作，它和deny的不同是：deny之后，客户端仍然可以提交请求，但使用drop后，客户端只有重新连接才可以访问。这个动作可以节省后端服务的连接数
- pass: 命中某条规则继续匹配下一条规则。可用于对请求进行精细地过滤，但会对响应速度有较大影响。
- pause: 命中某条规则，对当前事务暂停指定的毫秒。一般用于防止登录爆破。如果遭受DDOS攻击，会恶化整个web服务的响应速度
- proxy:  把命中规则的请求转发到另外一个web服务去。这个功能类似反向代理。由于它对客户端完全来说，完全是无感知，可以用它导向请求到蜜罐系统。这个动作是一个非常优秀的动作。
- redirect: 当规则被命中，它会返回一个重定向，指示浏览器访问另外一个url。它和proxy的区别是，它对客户端是感知。可用于配置新上线接口或屏蔽某些有问题的接口。

附图：
![waf](https://github.com/lceCre4m/lceCre4m.github.io/blob/master/img/waf.jpg?raw=true)

## 特征及检测
先上工具：https://github.com/EnableSecurity/wafw00f

检测WAF存在，一般是几种方法:
- 查看响应头部字段，是否有特征字段或不寻常字段或某些常见字段缺失
- 查看响应内容
- 尝试各种web攻击类型，和正常请求对比返回的状态码或返回内容。
- 尝试DOS攻击，超过一定次数后，看该IP的连接是否drop掉，再用另外一个IP查看，如果正常，说明触发了黑名单或CC防护。可以确认WAF存在

下面是业务常见的WAF特征：  

360 Firewall：
- 拦截状态码是493
- 响应头部包含X-Powered-By-360WZB
- 拦截的返回内容
- 引用指向 waf.360.cn
- 包含文本“Sorry! Your access has been intercepted because your links may threaten website security.”

阿里云盾：
- 拦截的状态码为405
- 拦截的返回内容
- 引用指向 errors.aliyun.com
- 包含文本“Sorry, your request has been blocked as it may cause potential threats to the server's security”

AWS (Amazon)：
- 拦截状态码为403
- 响应内容头部server包含”AWS“

百度云加速：server字段可能会为”Yunjiasu-nginx"或"Yunjiasu"

BitNinja: 拦截响应内容会包含“Security check by BitNinja”

思科ACE XML Gateway：server字段有“ACE XML Gateway"

Cloudflare:
- 响应头部：可能有cf-ray字段；server字段包含”cloudflare";Set-Cookie包含"__cfuid=".
- 响应内容：可能包含“Attention Required!”或“Cloudflare Ray ID:”；请求无效URL会有“CLOUDFLARE_ERROR_500S_BOX”返回

飞塔FortiWeb：
- 响应头部：在恶意请求返回情况会有“FORTIWAFSID=”
- 拦截返回的响应内容：会引用“.fgd_icon"图标；页面内容会有”Server Unavailable!“

华为云WAF：
- 拦截状态码为418
- 响应头部server为HuaweiCloudWAF
- 第一次响应"Set-Cookie"包含”HWWAFSESID“和”HWWAFSESTIME“

IBM DataPower：响应头部可能存在字段”X-Backside-Transport“，取值是”OK"或“FAIL"。

ModSecurity (Trustwave)：
- 响应头部server可能会包含”Mod_Security“或”NYOB“
- 拦截的响应内容会包含”This error was generated by Mod_Security", "One or more things in your request were suspicious", "rules of the mod_security module", "Protected by Mod Security"

NAXSI (NBS Systems)：
- 响应头部：server包含"naxsi/waf"；可能存在“X-Data-Origin”字段，值包含“naxsi/waf"
- 响应内容：包含”This Request Has Been Blocked By NAXSI“

绿盟WAF：server字段包含”NSFocus“

OpenResty Lua WAF：
- 拦截状态码为406
- 响应头部：server包含”openresty/{version}"
- 拦截内容包含“openresty/{version}"

腾讯云WAF：
- 拦截状态码为405
- 拦截内容会指向 waf.tencent-cloud.com

# 0x02 WAF绕过
关于waf的绕过，不同的waf有不同的过滤规则，绕过方式也不同，再加之不同攻击的绕过，比如sql注入，文件上传等分类，waf绕过方式十分繁杂。据我所知，大多数红队不怎么去碰waf，尽量找没有waf防护的站，一方面绕waf很困难，试了很久可能还不成功；另一方面红队需要节省时间。

所以，关于绕waf需要经验的积累，不同产品的waf使用不同的方式。常见绕过方式如：
- 修改请求方式绕过
- 编码绕过
- 特殊字符替换
- 特殊字符拼接
- 注释包含关键字
- 伪造搜索引擎
- 伪造白名单目录
- 直接攻击原站（云waf）
- 等等

推荐几篇文章，在绕waf时可以学习一下：  
https://cloud.tencent.com/developer/news/255979  
https://www.cnblogs.com/zqjt2/p/5600951.html  
https://www.freebuf.com/articles/web/229982.html







