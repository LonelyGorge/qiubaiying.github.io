---
layout:     post
title:      业务逻辑
date:       2020-05-14
author:     lceCr4m
header-img: img/yewuluoji.jpg
catalog: true
tags:
    - 业务逻辑
---
> 关于业务逻辑测试。包含：任意密码重置，验证码绕过，重放，业务流程绕过，支付逻辑，加密算法脆弱，条件竞争，前端认证。

# 0x00 前言
本文是想写业务逻辑测试的相关内容，但是因为内容太多太杂，所以我只写点重点的部分。
# 0x01 任意密码重置
## 基于修改密码
如果后台没有对旧密码进行验证，就直接让输入新密码。  
第一种方式，如果存在csrf漏洞，可以构造恶意链接发给用户。  
第二种，如果存在越权漏洞，就可以直接修改其他人的密码。点击修改后抓包测试，观察数据库包有没有验证类似cookie随机数，如果没有的话，可以尝试修改用户名、手机号或者uid来尝试重置其他密码。  
如果后台是通过向注册手机或者注册邮箱来重置密码的，关于验证码的漏洞我们都可以尝试，这种方式的前提是你已经通过某种方式进入到了对方的个人中心。~~但是我们可以基于找回密码来进行呀。~~
## 基于找回密码
密码找回逻辑含有==用户标识（用户名、用户 ID、cookie）、接收端（手机、邮箱）、凭证（验证码、token）、当前步骤==等四个要素，若这几个要素没有完整关联，则可能导致任意密码重置漏洞。
1. 短信验证码可爆破。
1. 验证码发送后前端返回 。
1. 用户名、手机号码、短信验证码三者没有进行匹配性验证。
1. 登陆成功修改密码功能平行越权。
1. 验证码有规律或可控 。
1. 输入验证码后通过修改响应包的状态来重置密码。
1. 重置密码链接中token值未验证或不失效或token可预测导致任意账号密码重置。
1. 跳过验证步骤重置任意账号密码。
1. 修改用户名、用户ID或手机号重置任意账号密码。
## 防御建议
1. 密码找回的凭证切勿下发客户端。校验邮箱是否有效应添加图片验证码，以防止关键参数被枚举。
1. 将重置用户与接收重置凭证的手机号/邮箱作一致性比较，通常直接从服务端直接生成手机号/邮箱，不从客户端获取。
1. 空密保问题时禁止通过密保找回密码。
1. 密码重置凭证强度提高，建议六位数字，有效期十分钟，并且验证码应校验一次后立即作废。
1. 服务端校验短信验证码后应通过cookie记录状态，不应在前端通过状态参数判断。
1. 密码重置链接中token尽可能随机化，若用常规加密算法，一定用客户端无法查看且猜测的因子作为盐值。另外，服务端应限制枚举等恶意请求。
1. HTTP 参数污染、参数未提交等问题，服务端也要严格判断。
# 0x02 验证码绕过
## 验证码机制
网站里的验证码分很多种，图形验证码、短信验证码、手拉验证码。  
机制：  
户端发起请求->服务端响应并创建一个新的SessionID同时生成随机验证码，将验证码和SessionID一并返回给客户端->客户端提交验证码连同SessionID给服务端->服务端验证验证码同时销毁当前会话，返回给客户端结果。
## 安全问题
### 客户端可能存在的安全问题
1. 有的网站验证码由本地js生成仅仅在本地用js验证。可以在本地禁用js，用burp把验证字段删除。
1. 有的网站把验证码输出到客户端html中，送到客户端Cookie或response headers。
1. 有些网站默认不显示验证码，而是在输入错误一定数量之后才需要验证验证码，开发人员可能在Cookie中写入一个标记loginErr，用来记录错误数量，则可以不更新Cookie中的loginErr值反复提交，验证码就不会出现。
### 服务端可能存在的安全问题
1. 验证码不过期或者不刷新，没有及时销毁会话导致同一验证码反复可用。攻击者可以在Cookie中带固定的sessionID和固定的验证码字符串。
1. 没有对验证码进行非空判断，导致可以直接删除验证码参数。
1. 产生的验证码问题有限。
2. 万能验证码
3. 验证码在认证一次后是否立即失效。
## 检测
1. 验证码和用户名、密码是否一次性、同时提交给服务器验证，如果是分开提交、分开验证，则存在漏洞。
1. 在服务器端，是否只有在验证码检验通过后才进行用户名和密码的检验，如果不是说明存在漏洞。
1. 验证码是否为图片形式且在一张图片中，不为图片形式或不在一张图片中，说明存在漏洞。
1. 查看网页html源码，或者抓包是否发现验证码。
1. 请求10次观察验证码是否随机生成，如果存在一定的规律（例如5次后出现同一验证码）说明存在漏洞。
## 防御建议
1. 验证识别后销毁session中的验证码。
1. 限制用户提交的验证码不能为空。
1. 判断提交的验证码与服务器上存储的是否一致。
1. 禁止将验证码明文信息发送至客户端。  
. . . . . . .
# 0x03 短信/语音验证码重放攻击
## 问题
1. 单个手机号无限制发送短信。  
1. 多个手机号无限制发送短信。  
1. 服务器对于发送短信设置不合理。
## 防御建议
1. 图文验证码：在发送验证码前，必须先进行图文识别，通过后才可发送验证码；除了有相当高的图文验证码识别技术，一般图文验证码是不容易被识别的，因此也是最有效的防攻击手段；
1. 流程改进：在发送验证码前，进行其他认证操作，比如密码设置、身份识别、输入更多信息等，使得虚假信息无法正常发送。
1. 接口签名：设置隐含的签名密钥，对接口请求参数进行签名，在服务器端进行签名有效性的验证。这种办法也是一种较为有效的方法，但密钥在客户端的安全需要得到保证。
1. 时间防护：限制手机号码在指定时间的发送次数，比如60s或120s内仅允许一次发送、一天仅允许10次发送等，防止频繁发送；这种方式无法彻底解决短信攻击问题。
1. ip防护：对发起发送请求的服务器ip进行限制。一般黑客发起攻击的服务器较为有限，当大批量的请求部署在服务器上时，后台会跟踪到频繁发送请求的黑客服务器ip地址，可以对其地址进行类似黑名单的管制。当发现同一个ip短期发送大量请求时，可以限制其访问。这种方式也无法彻底解决短信攻击问题。

图文验证码最为可靠，其次改进流程，再次是接口签名，时间防护和ip防护有其局限性，但前三种均需要升级App客户端，并且在App上进行图文验证、改进流程都影响用户体验，后面两种可以直接在服务器端生效
# 0x04 业务流程绕过
## 检测
1. 首先完成正常的业务逻辑步骤，获取每一个步骤的请求。
1. 绕过中间步骤，直接访问最后一个或几个验证请求，看是否可绕过。
## 防御建议
在不影响业务的前提下，在Session中添加对每一步流程页面的校验标志位，在新步骤页面浏览过程中，仅能够顺序执行页面校验，不可进行跳步操作。
# 0x05 加密算法脆弱
## 问题
1. 前端呈现加密算法代码
1. 算法脆弱，明文可判断
# 0x06 支付逻辑漏洞
## 问题
1. 购买数量修改
1. 支付金额修改
1. sign值可逆
1. 请求重放
# 0x07 条件竞争（HTTP并发）
## 介绍
竞争条件发生在多个线程同时访问同一个共享代码、变量、文件等没有进行锁操作或者同步操作的场景中。开发者在进行代码开发时常常倾向于认为代码会以线性的方式执行，而且他们忽视了并行服务器会并发执行多个线程，这就会导致意想不到的结果。  
造成的问题：
1. 购买-付款/购买/积分/订单操纵相关的漏洞
1. 兑换-积分/优惠券/注册邀请码
1. 次数-绕过次数限制
1. 多过程处理-如文件上传处理
1. 可能存在-DOS攻击

特点--共享同一资源，生成其他结果。 
## 防御
1. 对于数据库的操作的方法是设置锁。
1. 对于文件上传，一定要经过充分完整的检查之后再上传。
1. 在操作系统的角度，共享数据要进行上锁保护。
# 0x08 前端认证绕过
~~暂无~~
